import os
# æŠ‘åˆ¶ macOS ä¸Šæƒ±äººçš„ Tkinter ç‰ˆæœ¬è­¦å‘Š
os.environ['TK_SILENCE_DEPRECATION'] = '1'

import tkinter as tk
from tkinter import filedialog, scrolledtext, messagebox
import subprocess
import time
import threading
from datetime import datetime
import re

class YTRecorderApp:
    # ---------------------------------------------------------
    # é…è‰²æ–¹æ¡ˆå¸¸æ•¸ (UI v2.7 æ·±è‰²ä¸»é¡Œç‰ˆ)
    # ---------------------------------------------------------
    # ç‹€æ…‹ç‡ˆè™Ÿé¡è‰²
    COLOR_SUCCESS = "#2ecc71"
    COLOR_ERROR = "#e74c3c"
    COLOR_WARNING = "#f39c12"
    COLOR_INFO = "#3498db"
    COLOR_PRIMARY = "#27ae60"
    COLOR_DANGER = "#c0392b"
    
    # ä»‹é¢åŸºåº•é¡è‰² (æ”¹ç‚ºæ·±è‰²é«˜å°æ¯”ä¸»é¡Œï¼Œè§£æ±º macOS å¼·åˆ¶æ·±è‰²å°è‡´æ–‡å­—æ¶ˆå¤±çš„å•é¡Œ)
    BG_COLOR = "#2b2b2b"       # è¦–çª—èƒŒæ™¯ï¼šæ·±ç°
    FRAME_BG = "#2b2b2b"       # æ¡†æ¶èƒŒæ™¯ï¼šæ·±ç°
    TEXT_COLOR = "#ffffff"     # ä¸€èˆ¬æ–‡å­—ï¼šç´”ç™½ (é—œéµä¿®æ­£ï¼šç¢ºä¿åœ¨æ·±åº•ä¸Šå¯è¦‹)
    ENTRY_BG = "#404040"       # è¼¸å…¥æ¡†èƒŒæ™¯ï¼šç¨äº®ç°
    ENTRY_FG = "#ffffff"       # è¼¸å…¥æ¡†æ–‡å­—ï¼šç´”ç™½
    CURSOR_COLOR = "#ffffff"   # è¼¸å…¥æ¸¸æ¨™é¡è‰²ï¼šç™½ (é¿å…çœ‹ä¸è¦‹æ¸¸æ¨™)
    BORDER_COLOR = "#555555"   # é‚Šæ¡†é¡è‰²
    
    # å½è£ç”¨çš„ Headerï¼Œè§£æ±º 403 å•é¡Œ
    USER_AGENT = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"
    REFERER = "https://www.youtube.com/"

    def __init__(self, root):
        self.root = root
        self.root.title("YouTube ç›´æ’­éŒ„è£½ç¥å™¨ (macOSç‰ˆ) v2.8 - macOS æ¬„ä½ä¿®å¾©ç‰ˆ")
        self.root.geometry("920x850")
        self.root.minsize(800, 700)
        
        # å¼·åˆ¶è¨­å®šä¸»è¦–çª—èƒŒæ™¯é¡è‰²
        self.root.configure(bg=self.BG_COLOR)
        
        # [é—œéµä¿®æ­£] å»ºç«‹ä¸€å€‹ä¸»å®¹å™¨ Frame å¡«æ»¿æ•´å€‹è¦–çª—
        self.main_container = tk.Frame(self.root, bg=self.BG_COLOR)
        self.main_container.pack(fill="both", expand=True)

        # è®Šæ•¸åˆå§‹åŒ–
        self.is_monitoring = False
        self.monitor_thread = None
        self.stop_event = threading.Event()

        # Cookie ç‹€æ…‹è®Šæ•¸
        self.cookie_status_var = tk.StringVar(value="ç­‰å¾…æª¢æŸ¥...")

        # Cookie æ¸¬è©¦ç›®æ¨™
        self.cookie_test_url_var = tk.StringVar(
            value="https://www.youtube.com/live/KCDNSTKeiCc?si=V_R1wGF0KbhEbC6Z"
        )

        # æª¢æ¸¬é–“éš”ï¼ˆé è¨­å€¼ç‚º 300 ç§’ï¼‰
        self.check_interval_var = tk.StringVar(value="300")

        # é è¨­è·¯å¾‘
        default_dir = os.path.join(
            os.path.expanduser("~"), "Downloads", "yt_recorder_downloads"
        )
        self.download_dir = tk.StringVar(value=default_dir)

        # é è¨­é »é“
        self.channel_url = tk.StringVar(value="https://www.youtube.com/@Umitw46/live")

        # æ–°å¢ï¼šæ¸¬è©¦å½±ç‰‡ URL
        self.test_video_url = tk.StringVar(value="")

        # å»ºç«‹ä»‹é¢
        self.create_widgets()

        # ç¶å®šå¿«é€Ÿéµ
        self.root.bind('<Control-s>', lambda e: self.toggle_monitoring())
        self.root.bind('<Control-l>', lambda e: self.clear_logs())

        # å»¶é²åŸ·è¡Œ Cookie æª¢æŸ¥
        self.root.after(1000, lambda: self.check_cookies_thread(silent=True))

    def create_widgets(self):
        """å»ºç«‹ GUI å…ƒä»¶"""
        # é€šç”¨æ¨£å¼è¨­å®š (ç”¨æ–¼æ¸›å°‘é‡è¤‡ä»£ç¢¼)
        label_style = {"bg": self.BG_COLOR, "fg": self.TEXT_COLOR, "font": ("", 10)}
        frame_style = {"bg": self.BG_COLOR}
        
        # æ³¨æ„ï¼šæ‰€æœ‰å…ƒä»¶ç¾åœ¨éƒ½æ”¾åœ¨ self.main_container è€Œä¸æ˜¯ self.root
        
        # 1. æ ¸å¿ƒè¨­å®šå€
        config_frame = tk.LabelFrame(
            self.main_container, text="æ ¸å¿ƒè¨­å®šèˆ‡å·¥å…·",
            padx=15, pady=15,
            font=("", 10, "bold"),
            bg=self.BG_COLOR, fg=self.TEXT_COLOR, # å¼·åˆ¶ç™½å­—
            bd=1, relief="solid" # æ”¹ç”¨ solid é‚Šæ¡†åœ¨æ·±è‰²æ¨¡å¼è¼ƒæ¸…æ¥š
        )
        config_frame.pack(fill="x", padx=10, pady=8)
        
        # --- å·¥å…·åˆ— ---
        tools_frame = tk.Frame(config_frame, **frame_style)
        tools_frame.pack(fill="x", pady=(0, 10))
        
        tk.Button(
            tools_frame,
            text="ğŸ”„ æ›´æ–° yt-dlp æ ¸å¿ƒ",
            command=self.update_ytdlp,
            bg=self.COLOR_INFO,
            fg="black", # æŒ‰éˆ•ä¿æŒé»‘å­—æ¯”è¼ƒå¥½è®€
            padx=10,
            font=("", 9)
        ).pack(side="right")
        
        tk.Label(
            tools_frame, 
            text="é‡åˆ° 403 éŒ¯èª¤æ™‚ï¼Œè«‹å…ˆé»æ“Šå³å´æ›´æ–°æŒ‰éˆ• ğŸ‘‰", 
            bg=self.BG_COLOR, fg="#aaaaaa", font=("", 9) # ç°è‰²æç¤ºæ–‡å­—
        ).pack(side="right", padx=10)

        # Cookie æ¸¬è©¦å€
        cookie_input_frame = tk.Frame(config_frame, **frame_style)
        cookie_input_frame.pack(fill="x", pady=(0, 8))

        tk.Label(
            cookie_input_frame,
            text="Cookie æ¸¬è©¦å°è±¡:",
            **label_style
        ).pack(side="left")

        tk.Entry(
            cookie_input_frame,
            textvariable=self.cookie_test_url_var,
            width=45,
            bg=self.ENTRY_BG, fg=self.ENTRY_FG,
            insertbackground=self.CURSOR_COLOR, # æ¸¸æ¨™é¡è‰²
            highlightbackground=self.BORDER_COLOR,
            relief="flat"
        ).pack(side="left", padx=8)

        tk.Button(
            cookie_input_frame,
            text="åŸ·è¡Œ Cookie æ¬Šé™æ¸¬è©¦",
            command=lambda: self.check_cookies_thread(silent=False),
            bg=self.COLOR_INFO,
            fg="black",
            padx=12,
            cursor="hand2"
        ).pack(side="left", padx=5)

        # Cookie ç‹€æ…‹é¡¯ç¤º
        self.status_indicator = tk.Label(
            config_frame,
            textvariable=self.cookie_status_var,
            bg=self.BG_COLOR,
            fg=self.COLOR_WARNING,
            font=("", 11, "bold")
        )
        self.status_indicator.pack(anchor="w", padx=5, pady=(0, 12))

        # åˆ†éš”ç·š
        tk.Frame(config_frame, height=2, bd=0, bg=self.BORDER_COLOR).pack(
            fill="x", pady=8
        )

        # ç›´æ’­ç¶²å€è¨­å®š
        url_frame = tk.Frame(config_frame, **frame_style)
        url_frame.pack(fill="x", pady=(5, 0))
        tk.Label(url_frame, text="ç›´æ’­ç¶²å€:", **label_style).pack(side="left")
        tk.Entry(
            url_frame,
            textvariable=self.channel_url,
            width=50,
            bg=self.ENTRY_BG, fg=self.ENTRY_FG,
            insertbackground=self.CURSOR_COLOR,
            highlightbackground=self.BORDER_COLOR,
            relief="flat"
        ).pack(side="left", padx=8, fill="x", expand=True)

        # ç¯„ä¾‹æ–‡å­—
        tk.Label(
            config_frame,
            text="ç¯„ä¾‹ï¼šhttps://www.youtube.com/@é »é“åç¨±/live",
            bg=self.BG_COLOR,
            fg="#aaaaaa", # ç°è‰²
            font=("", 9)
        ).pack(anchor="w", padx=10, pady=(2, 8))

        # æª¢æ¸¬é–“éš”è¨­å®š
        interval_frame = tk.Frame(config_frame, **frame_style)
        interval_frame.pack(fill="x", pady=5)
        tk.Label(interval_frame, text="æª¢æ¸¬é »ç‡:", **label_style).pack(side="left")
        tk.Spinbox(
            interval_frame,
            from_=30,
            to=3600,
            textvariable=self.check_interval_var,
            width=10,
            validate='key',
            validatecommand=(self.root.register(self._validate_number), '%P'),
            bg=self.ENTRY_BG, fg=self.ENTRY_FG,
            insertbackground=self.CURSOR_COLOR,
            highlightbackground=self.BORDER_COLOR,
            relief="flat" # æ‰å¹³åŒ–é¢¨æ ¼
        ).pack(side="left", padx=8)
        tk.Label(interval_frame, text="ç§’", **label_style).pack(side="left", padx=2)
        tk.Label(
            interval_frame,
            text="(å»ºè­° 60 ç§’ä»¥ä¸Šï¼Œé¿å…è¢« YouTube é™åˆ¶)",
            bg=self.BG_COLOR,
            fg="#aaaaaa",
            font=("", 9)
        ).pack(side="left", padx=8)

        # 2. å½±ç‰‡æ¸¬è©¦ä¸‹è¼‰å€
        test_frame = tk.LabelFrame(
            self.main_container,
            text="å½±ç‰‡æ¸¬è©¦ä¸‹è¼‰",
            padx=15,
            pady=12,
            font=("", 10, "bold"),
            fg=self.COLOR_INFO,
            bg=self.BG_COLOR,
            bd=1, relief="solid"
        )
        test_frame.pack(fill="x", padx=10, pady=8)

        test_input_frame = tk.Frame(test_frame, **frame_style)
        test_input_frame.pack(fill="x", pady=(0, 5))

        tk.Label(
            test_input_frame,
            text="å½±ç‰‡ç¶²å€:",
            **label_style
        ).pack(side="left")

        tk.Entry(
            test_input_frame,
            textvariable=self.test_video_url,
            width=50,
            bg=self.ENTRY_BG, fg=self.ENTRY_FG,
            insertbackground=self.CURSOR_COLOR,
            highlightbackground=self.BORDER_COLOR,
            relief="flat"
        ).pack(side="left", padx=8, fill="x", expand=True)

        tk.Button(
            test_input_frame,
            text="ç«‹å³ä¸‹è¼‰",
            command=self.download_test_video,
            bg=self.COLOR_SUCCESS,
            fg="black",
            padx=15,
            cursor="hand2",
            font=("", 10, "bold")
        ).pack(side="left", padx=5)

        tk.Label(
            test_frame,
            text="ç”¨æ–¼æ¸¬è©¦ä¸€èˆ¬å½±ç‰‡ä¸‹è¼‰åŠŸèƒ½ï¼ˆéç›´æ’­ï¼‰ï¼Œæª”æ¡ˆæœƒå­˜åˆ°ç›¸åŒç›®éŒ„",
            bg=self.BG_COLOR,
            fg="#aaaaaa",
            font=("", 9)
        ).pack(anchor="w", padx=5)

        # 3. å„²å­˜è·¯å¾‘å€
        path_frame = tk.LabelFrame(
            self.main_container,
            text="å­˜æª”ä½ç½®",
            padx=15,
            pady=12,
            font=("", 10, "bold"),
            bg=self.BG_COLOR, fg=self.TEXT_COLOR,
            bd=1, relief="solid"
        )
        path_frame.pack(fill="x", padx=10, pady=8)

        tk.Entry(
            path_frame,
            textvariable=self.download_dir,
            width=60,
            state='readonly',
            bg=self.ENTRY_BG, fg=self.ENTRY_FG,
            readonlybackground="#333333", # Readonly æ·±ä¸€é»
            highlightbackground=self.BORDER_COLOR,
            relief="flat"
        ).pack(side="left", fill="x", expand=True, padx=(0, 8))

        tk.Button(
            path_frame,
            text="é¸æ“‡è³‡æ–™å¤¾",
            command=self.select_directory,
            bg=self.COLOR_INFO,
            fg="black",
            padx=15,
            cursor="hand2"
        ).pack(side="right")

        # 4. æ§åˆ¶å€
        control_frame = tk.Frame(self.main_container, pady=12, bg=self.BG_COLOR)
        control_frame.pack(fill="x", padx=10)

        self.btn_start = tk.Button(
            control_frame,
            text="é–‹å§‹è‡ªå‹•ç›£æ§ (Ctrl+S)",
            command=self.toggle_monitoring,
            bg=self.COLOR_PRIMARY,
            fg="black",
            font=("", 13, "bold"),
            height=2,
            cursor="hand2",
            relief="raised",
            bd=2
        )
        self.btn_start.pack(fill="x")

        # 5. ç‹€æ…‹é¡¯ç¤ºå€
        status_frame = tk.LabelFrame(
            self.main_container,
            text="é‹ä½œç‹€æ…‹èˆ‡æ—¥èªŒ",
            padx=12,
            pady=12,
            font=("", 10, "bold"),
            bg=self.BG_COLOR, fg=self.TEXT_COLOR,
            bd=1, relief="solid"
        )
        status_frame.pack(fill="both", expand=True, padx=10, pady=8)

        # æ—¥èªŒæ§åˆ¶æŒ‰éˆ•
        log_control_frame = tk.Frame(status_frame, **frame_style)
        log_control_frame.pack(fill="x", pady=(0, 5))

        tk.Button(
            log_control_frame,
            text="æ¸…é™¤æ—¥èªŒ (Ctrl+L)",
            command=self.clear_logs,
            bg="#95a5a6",
            fg="black",
            padx=10,
            cursor="hand2"
        ).pack(side="right")

        self.log_text = scrolledtext.ScrolledText(
            status_frame,
            height=15,
            state='disabled',
            font=("Courier", 10),
            wrap="word",
            bg="#1e1e1e", fg="#00ff00", # é»‘åº•ç¶ å­— (é§­å®¢é¢¨æ ¼æ—¥èªŒï¼Œå°æ¯”åº¦æœ€é«˜)
            highlightbackground=self.BORDER_COLOR,
            relief="flat"
        )
        self.log_text.pack(fill="both", expand=True)

        # åº•éƒ¨ç‹€æ…‹åˆ—
        self.status_label = tk.Label(
            self.main_container,
            text="å°±ç·’ | Ctrl+S: é–‹å§‹/åœæ­¢ | Ctrl+L: æ¸…é™¤æ—¥èªŒ",
            bd=1,
            relief=tk.SUNKEN,
            anchor=tk.W,
            font=("", 9),
            bg="#1e1e1e", fg="white" # ç‹€æ…‹åˆ—æ·±åº•ç™½å­—
        )
        self.status_label.pack(side=tk.BOTTOM, fill=tk.X)

    def _validate_number(self, value):
        """é©—è­‰æ•¸å­—è¼¸å…¥"""
        return value == "" or value.isdigit()

    def _validate_url(self, url):
        """é©—è­‰ URL æ ¼å¼"""
        url_pattern = re.compile(
            r'^https?://(www\.)?youtube\.com/.+$'
        )
        return bool(url_pattern.match(url))

    def log(self, message):
        """åŸ·è¡Œç·’å®‰å…¨çš„æ—¥èªŒè¼¸å‡º"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        full_msg = f"[{timestamp}] {message}"

        def _update():
            self.log_text.config(state='normal')
            self.log_text.insert(tk.END, full_msg + "\n")
            self.log_text.see(tk.END)
            self.log_text.config(state='disabled')

        self.root.after(0, _update)
        self.root.after(0, lambda: self.status_label.config(
            text=message[:100] + "..." if len(message) > 100 else message
        ))

    def clear_logs(self):
        """æ¸…é™¤æ—¥èªŒ"""
        self.log_text.config(state='normal')
        self.log_text.delete(1.0, tk.END)
        self.log_text.config(state='disabled')
        self.log("æ—¥èªŒå·²æ¸…é™¤")
    
    def update_ytdlp(self):
        """æ›´æ–° yt-dlp"""
        def _update_thread():
            self.log("ğŸ”„ æ­£åœ¨æ›´æ–° yt-dlpï¼Œè«‹ç¨å€™...")
            try:
                # å˜—è©¦ä½¿ç”¨ pip æ›´æ–°
                cmd = ["pip3", "install", "--upgrade", "yt-dlp"]
                result = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
                
                if result.returncode == 0:
                     self.log("âœ… pip æ›´æ–°æˆåŠŸï¼")
                else:
                    # å¦‚æœ pip å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ yt-dlp è‡ªå¸¶æ›´æ–° (é›–ç„¶ brew å®‰è£çš„é€šå¸¸ä¸å…è¨±é€™æ¨£åš)
                    self.log("âš ï¸ pip æ›´æ–°æœªå›å‚³æˆåŠŸï¼Œå˜—è©¦ brew æˆ–å…§å»ºæ›´æ–°...")
                    cmd_self = ["yt-dlp", "-U"]
                    result_self = subprocess.run(cmd_self, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
                    self.log(f"ğŸ“ æ›´æ–°çµæœ: {result_self.stdout} {result_self.stderr}")
                
                self.log("âœ… æ›´æ–°ç¨‹åºçµæŸï¼Œè«‹é‡è©¦éŒ„è£½ã€‚")
                self.root.after(0, lambda: messagebox.showinfo("æ›´æ–°å®Œæˆ", "æ›´æ–°ç¨‹åºå·²åŸ·è¡Œï¼Œè«‹æŸ¥çœ‹æ—¥èªŒç¢ºèªçµæœã€‚"))
                
            except Exception as e:
                self.log(f"âŒ æ›´æ–°å¤±æ•—: {e}")

        threading.Thread(target=_update_thread, daemon=True).start()

    def select_directory(self):
        """é¸æ“‡ä¸‹è¼‰ç›®éŒ„"""
        path = filedialog.askdirectory(initialdir=self.download_dir.get())
        if path:
            self.download_dir.set(path)
            self.log(f"å·²æ›´æ”¹ä¸‹è¼‰è·¯å¾‘: {path}")

    def download_test_video(self):
        """ä¸‹è¼‰æ¸¬è©¦å½±ç‰‡"""
        url = self.test_video_url.get().strip()

        if not url:
            messagebox.showwarning("è­¦å‘Š", "è«‹è¼¸å…¥å½±ç‰‡ç¶²å€")
            return

        if not self._validate_url(url):
            messagebox.showerror("éŒ¯èª¤", "è«‹è¼¸å…¥æœ‰æ•ˆçš„ YouTube ç¶²å€")
            return

        self.log(f"ğŸ“¥ é–‹å§‹ä¸‹è¼‰æ¸¬è©¦å½±ç‰‡...")

        # åœ¨æ–°åŸ·è¡Œç·’ä¸­ä¸‹è¼‰
        threading.Thread(
            target=self._download_video_impl,
            args=(url,),
            daemon=True
        ).start()

    def _download_video_impl(self, url):
        """åŸ·è¡Œå½±ç‰‡ä¸‹è¼‰ï¼ˆä¿®å¾© bot æª¢æ¸¬å•é¡Œï¼‰"""
        output_dir = self.download_dir.get()

        try:
            os.makedirs(output_dir, exist_ok=True)
        except Exception as e:
            self.log(f"âŒ ç„¡æ³•å‰µå»ºç›®éŒ„: {e}")
            return

        output_path = os.path.join(output_dir, "%(title)s-%(id)s.%(ext)s")

        # 403 éŒ¯èª¤ä¿®å¾©ï¼šåŠ å…¥ User-Agent, Referer å’Œ --no-cache-dir
        command = [
            "yt-dlp",
            "--no-cache-dir",  # é—œéµï¼šæ¸…é™¤å¿«å–
            "--cookies-from-browser", "chrome",
            "--user-agent", self.USER_AGENT, # å½è£ User Agent
            "--referer", self.REFERER,
            "--remote-components", "ejs:github",
            "-f", "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best",
            "--merge-output-format", "mp4",
            "-o", output_path,
            "--newline",
            "--progress",
            url
        ]

        self.log("ğŸ”§ ä½¿ç”¨å¼·åŒ–ç‰ˆåƒæ•¸ (Anti-403 Mode)...")

        try:
            process = subprocess.Popen(
                command,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                shell=False,
                bufsize=1
            )

            for line in process.stdout:
                line = line.strip()
                if line:
                    if "WARNING" in line and "Remote components" in line:
                        continue

                    if "Destination:" in line or "Merging" in line:
                        self.log(f"ğŸ“ {line}")
                    elif "[download]" in line and "%" in line:
                        if any(x in line for x in ["10%", "20%", "30%", "40%", "50%", 
                                                     "60%", "70%", "80%", "90%", "100%"]):
                            self.log(f"â¬ {line}")
                    elif "ETA" in line or "at" in line:
                        if line.startswith("[download]"):
                            self.log(f"â¬ {line}")

            process.wait()

            if process.returncode == 0:
                self.log("âœ… å½±ç‰‡ä¸‹è¼‰å®Œæˆï¼")
                self.root.after(0, lambda: messagebox.showinfo("æˆåŠŸ", "å½±ç‰‡ä¸‹è¼‰å®Œæˆï¼"))
            else:
                self.log(f"âŒ ä¸‹è¼‰å¤±æ•—ï¼Œè¿”å›ç¢¼: {process.returncode}")
                self.root.after(0, lambda: messagebox.showerror("éŒ¯èª¤", "å½±ç‰‡ä¸‹è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ"))

        except FileNotFoundError:
            self.log("âŒ æ‰¾ä¸åˆ° yt-dlp å·¥å…·")
            self.root.after(0, lambda: messagebox.showerror(
                "éŒ¯èª¤", 
                "æ‰¾ä¸åˆ° yt-dlp\n\nè«‹å…ˆå®‰è£ï¼šbrew install yt-dlp"
            ))
        except Exception as e:
            self.log(f"âŒ ä¸‹è¼‰éŒ¯èª¤: {str(e)}")
            self.root.after(0, lambda: messagebox.showerror("éŒ¯èª¤", f"ä¸‹è¼‰éŒ¯èª¤: {str(e)}"))

    def check_cookies_thread(self, silent=False):
        """å•Ÿå‹• Cookie æª¢æŸ¥åŸ·è¡Œç·’"""
        threading.Thread(
            target=self._check_cookies_impl,
            args=(silent,),
            daemon=True
        ).start()

    def _check_cookies_impl(self, silent=False):
        """åŸ·è¡Œ Cookie æª¢æŸ¥ï¼ˆä¿®å¾© bot æª¢æ¸¬å•é¡Œï¼‰"""
        test_url = self.cookie_test_url_var.get().strip()

        if not test_url:
            test_url = "https://www.youtube.com/watch?v=jNQXAC9IVRw"

        if not self._validate_url(test_url):
            self.log("âŒ ç„¡æ•ˆçš„ YouTube ç¶²å€")
            self._update_cookie_ui(False, "âŒ ç¶²å€æ ¼å¼éŒ¯èª¤", self.COLOR_ERROR)
            return

        if not silent:
            self.log(f"æ­£åœ¨æª¢æŸ¥ Cookie æ¬Šé™...")
            self._update_cookie_ui(False, "æª¢æŸ¥ä¸­...", self.COLOR_WARNING)

        # 403 éŒ¯èª¤ä¿®å¾©ï¼šåŒæ­¥ä½¿ç”¨å½è£åƒæ•¸
        command = [
            "yt-dlp",
            "--no-cache-dir",
            "--cookies-from-browser", "chrome",
            "--user-agent", self.USER_AGENT,
            "--referer", self.REFERER,
            "--remote-components", "ejs:github",
            "--print", "title",
            test_url
        ]

        try:
            result = subprocess.run(
                command,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
                timeout=60,
                shell=False
            )

            if result.returncode == 0:
                title = result.stdout.strip()
                success_msg = f"âœ… é©—è­‰æˆåŠŸ (æ¨™é¡Œ: {title[:25]}...)"
                self._update_cookie_ui(True, success_msg, self.COLOR_SUCCESS)
                if not silent:
                    self.log(f"âœ… Cookie æœ‰æ•ˆï¼æˆåŠŸè®€å–å½±ç‰‡: {title}")
                    self.root.after(0, lambda: messagebox.showinfo(
                        "é©—è­‰æˆåŠŸ",
                        f"Cookie é‹ä½œæ­£å¸¸ï¼\n\nå½±ç‰‡æ¨™é¡Œï¼š{title}\n\n"
                        "å¦‚æœé€™æ˜¯æœƒå“¡é™å®šå…§å®¹ï¼Œä»£è¡¨æ¬Šé™å·²æ­£ç¢ºæŠ“å–ã€‚"
                    ))
            else:
                self._update_cookie_ui(False, "âŒ å­˜å–å¤±æ•—", self.COLOR_ERROR)
                error_msg = result.stderr
                if "WARNING" not in error_msg or "Remote components" not in error_msg:
                    self.log(f"âŒ Cookie æª¢æŸ¥å¤±æ•—: {error_msg[:100]}")
                if not silent:
                    self._show_cookie_error(error_msg)

        except FileNotFoundError:
            self._update_cookie_ui(False, "âŒ æ‰¾ä¸åˆ° yt-dlp", self.COLOR_ERROR)
            if not silent:
                self.root.after(0, lambda: messagebox.showerror(
                    "éŒ¯èª¤",
                    "æ‰¾ä¸åˆ° yt-dlp å·¥å…·ã€‚\n\nè«‹å…ˆå®‰è£ï¼š\nbrew install yt-dlp"
                ))
        except subprocess.TimeoutExpired:
            self._update_cookie_ui(False, "âŒ æª¢æŸ¥è¶…æ™‚", self.COLOR_ERROR)
            self.log("âŒ Cookie æª¢æŸ¥è¶…æ™‚ï¼ˆ60ç§’ï¼‰")
        except Exception as e:
            self._update_cookie_ui(False, "âŒ éŒ¯èª¤", self.COLOR_ERROR)
            self.log(f"âŒ æœªçŸ¥éŒ¯èª¤: {str(e)}")

    def _show_cookie_error(self, stderr):
        """é¡¯ç¤º Cookie éŒ¯èª¤è©³æƒ…"""
        err_msg = "ç„¡æ³•è®€å–å½±ç‰‡è³‡è¨Šã€‚\n\n"

        if "Sign in to confirm" in stderr or "age" in stderr.lower():
            err_msg += "åŸå› ï¼šéœ€è¦ç™»å…¥ï¼ˆCookie ç„¡æ•ˆæˆ–æœªæŠ“å–ï¼‰"
        elif "Private video" in stderr:
            err_msg += "åŸå› ï¼šé€™æ˜¯ç§äººå½±ç‰‡ï¼ˆéœ€è¦ç‰¹å®šæ¬Šé™ï¼‰"
        elif "Members-only" in stderr or "members only" in stderr.lower():
            err_msg += "åŸå› ï¼šæœƒå“¡é™å®šå…§å®¹ï¼Œä½†æ‚¨çš„ Cookie æ²’æœ‰æ¬Šé™"
        elif "403" in stderr:
            err_msg += "åŸå› ï¼š403 ç¦æ­¢è¨ªå•ã€‚å¯èƒ½æ˜¯ IP è¢«æ“‹æˆ– yt-dlp éœ€è¦æ›´æ–°ã€‚"
        else:
            err_msg += f"éŒ¯èª¤è©³æƒ…ï¼š{stderr[:200]}"

        err_msg += ("\n\nå»ºè­°æ“ä½œï¼š\n"
                   "1. ä½¿ç”¨ä»‹é¢ä¸Šçš„æŒ‰éˆ•æ›´æ–° yt-dlp\n"
                   "2. é–‹å•Ÿ Chrome ä¸¦ç™»å…¥ YouTubeï¼Œç¢ºèªå½±ç‰‡å¯æ’­æ”¾\n"
                   "3. å®Œå…¨é—œé–‰ Chrome å¾Œé‡è©¦")

        self.root.after(0, lambda: messagebox.showerror("é©—è­‰å¤±æ•—", err_msg))

    def _update_cookie_ui(self, success, text, color):
        """æ›´æ–° Cookie ç‹€æ…‹ä»‹é¢"""
        def _update():
            self.cookie_status_var.set(text)
            self.status_indicator.config(fg=color)
        self.root.after(0, _update)

    def toggle_monitoring(self):
        """åˆ‡æ›ç›£æ§ç‹€æ…‹"""
        if not self.is_monitoring:
            # é©—è­‰è¼¸å…¥
            try:
                interval = int(self.check_interval_var.get())
                if interval < 10:
                    messagebox.showerror(
                        "éŒ¯èª¤",
                        "æª¢æ¸¬é–“éš”ä¸èƒ½å°æ–¼ 10 ç§’"
                    )
                    return
                elif interval < 30:
                    if not messagebox.askyesno(
                        "è­¦å‘Š",
                        "æª¢æ¸¬é–“éš”å°æ–¼ 30 ç§’å¯èƒ½å°è‡´ IP è¢« YouTube é™åˆ¶ã€‚\nç¢ºå®šç¹¼çºŒï¼Ÿ"
                    ):
                        return
            except ValueError:
                messagebox.showerror("éŒ¯èª¤", "æª¢æ¸¬é »ç‡å¿…é ˆæ˜¯æœ‰æ•ˆæ•¸å­—")
                return

            # é©—è­‰ URL
            url = self.channel_url.get().strip()
            if not self._validate_url(url):
                messagebox.showerror("éŒ¯èª¤", "è«‹è¼¸å…¥æœ‰æ•ˆçš„ YouTube ç¶²å€")
                return

            # é–‹å§‹ç›£æ§
            self.is_monitoring = True
            self.stop_event.clear()
            self.btn_start.config(
                text="åœæ­¢ç›£æ§ (Ctrl+S)",
                bg=self.COLOR_DANGER
            )
            self.log(f"=== é–‹å§‹ç›£æ§ (é–“éš”: {interval}ç§’) ===")

            self.monitor_thread = threading.Thread(
                target=self.monitor_loop,
                daemon=True
            )
            self.monitor_thread.start()
        else:
            # åœæ­¢ç›£æ§
            self.is_monitoring = False
            self.stop_event.set()
            self.btn_start.config(
                text="é–‹å§‹è‡ªå‹•ç›£æ§ (Ctrl+S)",
                bg=self.COLOR_PRIMARY
            )
            self.log("â¸ æ­£åœ¨åœæ­¢ç›£æ§...")

    def is_live(self, url):
        """æª¢æŸ¥æ˜¯å¦æ­£åœ¨ç›´æ’­ï¼ˆä¿®å¾© bot æª¢æ¸¬å•é¡Œï¼‰"""
        # 403 éŒ¯èª¤ä¿®å¾©ï¼šåŒæ­¥ä½¿ç”¨å½è£åƒæ•¸
        command = [
            "yt-dlp",
            "--no-cache-dir",
            "--cookies-from-browser", "chrome",
            "--user-agent", self.USER_AGENT,
            "--referer", self.REFERER,
            "--remote-components", "ejs:github",
            "--get-title",
            url
        ]

        try:
            result = subprocess.run(
                command,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
                timeout=30,
                shell=False
            )

            if result.returncode == 0:
                title = result.stdout.strip()
                self.log(f"ğŸ‰ æª¢æ¸¬åˆ°ç›´æ’­: {title}")
                return True
            else:
                stderr = result.stderr.strip()
                if "will begin in" in stderr:
                    self.log("â„¹ï¸ é å®šç›´æ’­å°šæœªé–‹å§‹")
                return False

        except subprocess.TimeoutExpired:
            self.log("âš ï¸ æª¢æ¸¬è¶…æ™‚")
            return False
        except Exception as e:
            self.log(f"âš ï¸ æª¢æ¸¬éŒ¯èª¤: {str(e)}")
            return False

    def record_live_stream(self, url):
        """éŒ„è£½ç›´æ’­ï¼ˆä¿®å¾©æ‰€æœ‰å•é¡Œï¼‰"""
        output_dir = self.download_dir.get()

        try:
            os.makedirs(output_dir, exist_ok=True)
        except Exception as e:
            self.log(f"âŒ ç„¡æ³•å‰µå»ºç›®éŒ„: {e}")
            return

        output_path = os.path.join(output_dir, "%(title)s-%(id)s.%(ext)s")

        # å®Œæ•´ä¿®å¾©çš„å‘½ä»¤ (é‡å° 403 éŒ¯èª¤èˆ‡ç›´æ’­æ–·ç·š)
        command = [
            "yt-dlp",
            "--ignore-config", # å¿½ç•¥æœ¬åœ°è¨­å®šæª”ï¼Œé¿å…è¡çª
            "--no-cache-dir",  # é—œéµï¼šè§£æ±º 403 é‡è¤‡ç™¼ç”Ÿ
            "--cookies-from-browser", "chrome",
            "--user-agent", self.USER_AGENT, # å½è£ç‚º Mac Chrome
            "--referer", self.REFERER,
            "--remote-components", "ejs:github",
            "--live-from-start",
            "--wait-for-video", "5-60",
            "-f", "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best",
            "--merge-output-format", "mp4",
            "--hls-use-mpegts",
            # å¦‚æœé‚„æ˜¯ 403ï¼Œå¯ä»¥å˜—è©¦ç§»é™¤ concurrent-fragments è®“ä¸‹è¼‰è®Šæ…¢ä½†æ›´ç©©å®š
            "--concurrent-fragments", "5", 
            "--no-part",
            "--newline",
            "--progress",
            "-o", output_path,
            url
        ]

        self.log("ğŸš€ å•Ÿå‹•éŒ„è£½...")
        self.log("ğŸ”§ ä½¿ç”¨ Bot é˜²è­·ç¹éæ©Ÿåˆ¶ (No-Cache + UA Spoof)...")

        process = None
        try:
            start_time = time.time()
            process = subprocess.Popen(
                command,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                shell=False,
                bufsize=1
            )

            last_log_time = 0
            for line in process.stdout:
                line = line.strip()
                if line:
                    # éæ¿¾ WARNING è¨Šæ¯
                    if "WARNING" in line and "Remote components" in line:
                        continue

                    current_time = time.time()
                    # æ¯10ç§’è¼¸å‡ºä¸€æ¬¡é€²åº¦
                    if current_time - last_log_time >= 10:
                        if "[download]" in line:
                            self.log(f"â¬ {line}")
                            last_log_time = current_time

                    # é‡è¦è¨Šæ¯ç«‹å³é¡¯ç¤º
                    if "Destination:" in line or "Merging" in line or "ERROR" in line:
                        self.log(f"ğŸ“ {line}")
                    
                    # åµæ¸¬åˆ° 403 æ™‚æç¤ºä½¿ç”¨è€…
                    if "HTTP Error 403" in line and "Retrying" not in line:
                        self.log(f"âš ï¸ åµæ¸¬åˆ° 403 æ‹’çµ•è¨ªå•ï¼Œè«‹å˜—è©¦æ›´æ–° yt-dlp æˆ–æ›´æ› IP")

                if self.stop_event.is_set():
                    process.terminate()
                    self.log("â¹ ä½¿ç”¨è€…åœæ­¢éŒ„è£½")
                    break

                elapsed = int(time.time() - start_time)
                h, remainder = divmod(elapsed, 3600)
                m, s = divmod(remainder, 60)

                def update_status():
                    self.status_label.config(
                        text=f"ğŸ”´ éŒ„è£½ä¸­... {h:02d}:{m:02d}:{s:02d}"
                    )
                self.root.after(0, update_status)

            process.wait()

            if process.returncode == 0:
                self.log("âœ… éŒ„è£½å®Œæˆï¼")
            elif not self.stop_event.is_set():
                self.log(f"âš ï¸ éŒ„è£½çµæŸï¼ˆè¿”å›ç¢¼: {process.returncode}ï¼‰")

        except Exception as e:
            self.log(f"âŒ éŒ„è£½éŒ¯èª¤: {str(e)}")
        finally:
            if process and process.poll() is None:
                try:
                    process.terminate()
                    process.wait(timeout=5)
                except Exception:
                    process.kill()

    def monitor_loop(self):
        """ä¸»ç›£æ§è¿´åœˆ"""
        url = self.channel_url.get().strip()

        while not self.stop_event.is_set():
            try:
                check_interval = int(self.check_interval_var.get())
            except ValueError:
                check_interval = 120

            self.log(f"ğŸ” æª¢æ¸¬ç›´æ’­ç‹€æ…‹...")

            if self.is_live(url):
                self.log("ğŸ“¡ ç¢ºèªç›´æ’­ä¿¡è™Ÿï¼Œæº–å‚™éŒ„è£½...")
                time.sleep(3)
                self.record_live_stream(url)

                # éŒ„è£½å¾Œå†·å»
                self.log("ğŸ’¤ éŒ„è£½çµæŸï¼Œå†·å» 60 ç§’...")
                for _ in range(60):
                    if self.stop_event.is_set():
                        break
                    time.sleep(1)
            else:
                # å€’æ•¸è¨ˆæ™‚ç­‰å¾…
                for i in range(check_interval):
                    if self.stop_event.is_set():
                        break

                    if i % 10 == 0:
                        remaining = check_interval - i
                        def update_waiting():
                            self.status_label.config(
                                text=f"â³ ç­‰å¾…ä¸‹æ¬¡æª¢æ¸¬... å‰©é¤˜ {remaining} ç§’"
                            )
                        self.root.after(0, update_waiting)

                    time.sleep(1)

        self.log("=== ç›£æ§å·²åœæ­¢ ===")
        self.root.after(0, lambda: self.status_label.config(text="å°±ç·’"))

if __name__ == "__main__":
    try:
        root = tk.Tk()
        app = YTRecorderApp(root)
        root.mainloop()
    except tk.TclError as e:
        # æ•æ‰ç„¡é¡¯ç¤ºå™¨éŒ¯èª¤ï¼Œé¡¯ç¤ºå‹å–„æç¤º
        if "no display name" in str(e) or "no $DISPLAY" in str(e):
            print("\n=======================================================")
            print("âŒ éŒ¯èª¤ï¼šç„¡æ³•å•Ÿå‹•åœ–å½¢ä»‹é¢ (No Display Found)")
            print("=======================================================")
            print("åŸå› ï¼šæ­¤ç¨‹å¼ç‚ºè¦–çª—æ‡‰ç”¨ç¨‹å¼ (GUI)ï¼Œç„¡æ³•åœ¨é›²ç«¯ Shell æˆ–ç„¡è¢å¹•ä¼ºæœå™¨åŸ·è¡Œã€‚")
            print("\nè§£æ±ºæ–¹æ³•ï¼š")
            print("1. è«‹å°‡æ­¤æª”æ¡ˆ (YT_recorder_v3_fixed.py) ä¸‹è¼‰åˆ°æ‚¨çš„ macOS é›»è…¦ã€‚")
            print("2. é–‹å•Ÿçµ‚ç«¯æ©Ÿ (Terminal)ã€‚")
            print("3. è¼¸å…¥æŒ‡ä»¤ï¼špython3 /æ‚¨çš„ä¸‹è¼‰è·¯å¾‘/YT_recorder_v3_fixed.py")
            print("=======================================================\n")
        else:
            raise e
